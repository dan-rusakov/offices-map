"use strict";ymaps.ready(function(){var e,t,s=document.querySelector(".city-template").content,u=document.querySelector(".office-template").content,d=document.querySelector(".country-btn-template").content,m="",f=new ymaps.Map("map",{center:[55.76,37.64],zoom:7,controls:[]},{suppressMapOpenBlock:!0}),p=ymaps.templateLayoutFactory.createClass('<div class="balloon-box"><p class="balloon-box__office">$[properties.balloonOffice]</p><p class="balloon-box__manager-name">$[properties.balloonManagerName]</p><div class="balloon-box__phones-list">$[properties.balloonPhone]</div><div class="balloon-box__emails-list">$[properties.balloonEmail]</div><svg  class="icon balloon-box__close" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><polygon points="16 1.6 14.4 0 8 6.4 1.6 0 0 1.6 6.4 8 0 14.4 1.6 16 8 9.6 14.4 16 16 14.4 9.6 8" fill="#fff"/></svg></div>',{build:function(){this.constructor.superclass.build.call(this),this.$element=$(this.getParentElement()).find(".balloon-box"),this.$element.find(".balloon-box__close").on("click",$.proxy(this._onCloseButtonClick,this))},clear:function(){this.$element.find(".balloon-box__close").off("click"),this.constructor.superclass.clear.call(this)},_onCloseButtonClick:function(e){e.preventDefault(),this.events.fire("userclose")}});e=function(a){var n;function t(e,t){var o=e.filter(function(e){return e.country==t});m=(m=o.map(function(t){return t.offices.map(function(e){return t.city+", "+e.adress})})).reduce(function(e,t){return e.concat(t)});var n=document.createDocumentFragment();o.forEach(function(e,t){var o=s.cloneNode(!0);o.querySelector(".city__name").textContent=e.city,o.querySelector(".city__offices-box").appendChild(function(e){var o=document.createDocumentFragment();return e.offices.forEach(function(e,t){var n=u.cloneNode(!0);n.querySelector(".city__office-name").textContent="Офис "+e.adress.toUpperCase(),n.querySelector(".city__manager-name").textContent=e.managerName,e.phones.forEach(function(e,t){var o=document.createElement("p");o.className="city__phone",o.textContent=e,n.querySelector(".city__phones-list").appendChild(o)}),e.emails.forEach(function(e,t){var o=document.createElement("a");o.className="city__email",o.textContent=e,o.href="mailto:"+e,n.querySelector(".city__emails-list").appendChild(o)}),o.appendChild(n)}),o}(e)),n.appendChild(o)});for(var a=document.querySelector(".sidebar__cities-list");a.firstChild;)a.removeChild(a.firstChild);a.appendChild(n),function(){for(var e=document.querySelectorAll(".city__header"),t=0;t<e.length;t++)e[t].addEventListener("click",o),e[t].addEventListener("keydown",function(e){13===e.keyCode&&o(e)});function o(e){var t=e.currentTarget;t.classList.toggle("active"),t.classList.contains("active")?t.nextElementSibling.style.maxHeight=t.nextElementSibling.scrollHeight+"px":t.nextElementSibling.style.maxHeight="0px"}}(),function(){for(var e=document.querySelectorAll(".city__office-name"),t=0;t<e.length;t++)e[t].addEventListener("click",o),e[t].addEventListener("keydown",function(e){13===e.keyCode&&o(e)});function o(e){var t=e.target.closest(".city").querySelector(".city__name").textContent+","+e.target.textContent.slice(4);ymaps.geocode(t).then(function(e){f.panTo(e.geoObjects.get(0).geometry.getCoordinates())})}}()}n=document.createDocumentFragment(),function(e){var o=[];return e.forEach(function(e,t){0<t?-1==o.indexOf(e.country)&&o.push(e.country):o.push(e.country)}),o}(a).forEach(function(e,t){var o=d.cloneNode(!0);0==t&&(o.querySelector(".sidebar__country-input").checked=!0),o.querySelector(".sidebar__country-input").id=e,o.querySelector(".sidebar__btn").htmlFor=e,o.querySelector(".sidebar__btn").dataset.country=e,o.querySelector(".sidebar__btn-text").textContent=e,n.appendChild(o)}),document.querySelector(".sidebar__btn-box").appendChild(n),t(a,"Россия");for(var e=document.querySelectorAll(".sidebar__btn"),o=0;o<e.length;o++)e[o].addEventListener("click",r),e[o].addEventListener("keydown",function(e){13===e.keyCode&&r(e)});function r(e){e.currentTarget.classList.toggle("active"),t(a,e.currentTarget.dataset.country),c(m)}function c(e){f.geoObjects.removeAll();for(var t=ymaps.templateLayoutFactory.createClass('<div style="color: #FFFFFF; font-weight: bold;">{{ properties.geoObjects.length }}</div>'),n=new ymaps.Clusterer({clusterIcons:[{href:"../img/clusterIcon.svg",size:[40,40],offset:[-20,-20]}],clusterIconContentLayout:t,groupByCoordinates:!1,gridSize:80,clusterDisableClickZoom:!1}),o=0;o<e.length;o++){ymaps.geocode(e[o]).then(function(e){var t=l(e.geoObjects.get(0).properties.get("text")),o=e.geoObjects.get(0).geometry.getCoordinates();window.placemark=new ymaps.Placemark(o,{balloonOffice:"Офис "+t.adress,balloonManagerName:t.managerName,balloonPhone:i(t.phones,"phone"),balloonEmail:i(t.emails,"email")},{balloonShadow:!1,balloonLayout:p,balloonPanelMaxMapArea:0,balloonMaxWidth:800,iconLayout:"default#imageWithContent",hideIconOnBalloonOpen:!1,iconImageHref:"../img/singleIcon.svg",iconImageSize:[24,24],iconImageOffset:[-12,-12]}),n.add(placemark),f.setBounds(n.getBounds())})}f.geoObjects.add(n)}function l(e){var t=e.split(", "),o=t[t.length-3],n=t[t.length-2]+", "+t[t.length-1];return(t=(t=a.filter(function(e){return e.city.toLowerCase()==o.toLowerCase()}))[0].offices.filter(function(e){return e.adress.toLowerCase()==n.toLowerCase()}))[0]}function i(e,o){var n="";return"phone"==o?e.forEach(function(e,t){n+='<p class="balloon-box__'+o+'">'+e+"</p>"}):"email"==o&&e.forEach(function(e,t){n+='<a class="balloon-box__'+o+'" href="mailto:'+e+'">'+e+"</a>"}),n}c(m),f.geoObjects.events.add("click",function(e){var t=e.get("target");ymaps.geocode(t.geometry.getCoordinates(),{}).then(function(e){!function(e){for(var t=document.querySelectorAll(".city__name"),o=0;o<t.length;o++)t[o].textContent==e&&(t[o].parentNode.classList.add("active"),t[o].parentNode.nextElementSibling.style.maxHeight=t[o].parentNode.nextElementSibling.scrollHeight+"px")}(e.geoObjects.get(0).getLocalities())}),"Point"===t.geometry.getType()&&f.panTo(t.geometry.getCoordinates(),f.getZoom(),{checkZoomRange:!0})})},(t=new XMLHttpRequest).responseType="json",t.open("GET","../data.json"),t.addEventListener("load",function(){e(t.response)}),t.send()});